env GATEWAY_SHARED_SECRET;
env RATE_LIMIT_DISABLED;
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Lua search path and cache
    lua_package_path "$prefix/gateway/lua/?.lua;$prefix/gateway/lua/resty/?.lua;$prefix/lualib/?.lua;$prefix/lualib/?/init.lua;;";
    lua_package_cpath "$prefix/lualib/?.so;$prefix/lualib/loadall.so;;";
    lua_code_cache on;

    default_type application/json;

    lua_shared_dict jwks_cache 1m;
    lua_shared_dict jwt_cache 10m;
    lua_shared_dict rate_limit_store 10m;

    resolver 127.0.0.11 valid=30s;

    log_format timed '$remote_addr - $remote_user [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '$request_time $upstream_response_time '
                     '"$http_referer" "$http_user_agent"';

    access_log /dev/stdout timed;
    error_log  /dev/stderr info;

    upstream auth_service {
        server auth-service:3001;
    }

    upstream analytics_service {
        server analytics-service:3006;
    }

    upstream alerts_service {
        server alerts-service:5005;
    }

    upstream tenant_router {
        server tenant-router:3004;
    }

    server {
        listen 18080;
        server_name localhost;

        location /health {
            add_header Content-Type application/json;
            return 200 '{"status":"ok"}';
        }

        # -------- PUBLIC AUTH ROUTES --------
        location /auth/ {
            access_by_lua_block {
                local ratelimit = require("ratelimit")
                ratelimit.enforce()
            }

            proxy_pass http://auth_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # -------- TENANT ROUTER --------
        location /tenant/ {
            access_by_lua_block {
                local auth = require("auth")
                auth.authenticate()
            }

            proxy_pass http://tenant_router/;
            proxy_set_header x-user-id  $http_x_user_id;
            proxy_set_header x-brand-id $http_x_brand_id;
            proxy_set_header x-role     $http_x_role;
        }

        # -------- PROTECTED ANALYTICS ROUTES --------
        location /analytics/ {
            access_by_lua_block {
                local t0 = ngx.now()
                local auth = require("auth")
                auth.authenticate()
                local t1 = ngx.now()

                local ratelimit = require("ratelimit")
                ratelimit.enforce()
                local t2 = ngx.now()

                ngx.log(ngx.NOTICE, string.format("[gw-timing] auth=%.3fms rate=%.3fms",
                    (t1 - t0) * 1000, (t2 - t1) * 1000))
            }

            # Strip /analytics prefix and forward to analytics root
            proxy_pass http://analytics_service/;
            proxy_set_header x-user-id  $http_x_user_id;
            proxy_set_header x-brand-id $http_x_brand_id;
            proxy_set_header x-role     $http_x_role;
        }

        # -------- ALERTS SERVICE (author-only) --------
        # Handle /alerts without redirect to avoid scheme/port rewrite issues.
        location = /alerts {
            access_by_lua_block {
                local t0 = ngx.now()
                local auth = require("auth")
                auth.authenticate()
                local t1 = ngx.now()

                local ratelimit = require("ratelimit")
                ratelimit.enforce()
                local t2 = ngx.now()

                ngx.log(ngx.NOTICE, string.format("[gw-timing] auth=%.3fms rate=%.3fms",
                    (t1 - t0) * 1000, (t2 - t1) * 1000))
            }

            proxy_pass http://alerts_service/alerts;
            proxy_set_header x-user-id  $http_x_user_id;
            proxy_set_header x-brand-id $http_x_brand_id;
            proxy_set_header x-role     $http_x_role;
        }

        location /alerts/ {
            access_by_lua_block {
                local t0 = ngx.now()
                local auth = require("auth")
                auth.authenticate()
                local t1 = ngx.now()

                local ratelimit = require("ratelimit")
                ratelimit.enforce()
                local t2 = ngx.now()

                ngx.log(ngx.NOTICE, string.format("[gw-timing] auth=%.3fms rate=%.3fms",
                    (t1 - t0) * 1000, (t2 - t1) * 1000))
            }

            proxy_pass http://alerts_service/alerts/;
            proxy_set_header x-user-id  $http_x_user_id;
            proxy_set_header x-brand-id $http_x_brand_id;
            proxy_set_header x-role     $http_x_role;
        }
    }
}
