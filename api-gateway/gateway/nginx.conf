env GATEWAY_SHARED_SECRET;
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Lua search path and cache
    lua_package_path "$prefix/gateway/lua/?.lua;$prefix/gateway/lua/resty/?.lua;$prefix/lualib/?.lua;$prefix/lualib/?/init.lua;;";
    lua_package_cpath "$prefix/lualib/?.so;$prefix/lualib/loadall.so;;";
    lua_code_cache off;

    default_type application/json;

    lua_shared_dict jwks_cache 1m;
    lua_shared_dict rate_limit_store 10m;

    resolver 8.8.8.8 valid=30s;

    access_log /dev/stdout;
    error_log  /dev/stderr info;

    upstream auth_service {
        server 127.0.0.1:3001;
    }

    upstream analytics_service {
        server 127.0.0.1:3000;
    }

    server {
        listen 18080;
        server_name localhost;

        # -------- PUBLIC AUTH ROUTES --------
        location /auth/ {
            access_by_lua_block {
                local ratelimit = require("ratelimit")
                ratelimit.enforce()
            }

            proxy_pass http://auth_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # -------- PROTECTED ANALYTICS ROUTES --------
        location /analytics/ {
            access_by_lua_block {
                local auth = require("auth")
                auth.authenticate()

                local ratelimit = require("ratelimit")
                ratelimit.enforce()
            }

            # Strip /analytics prefix and forward to analytics root
            proxy_pass http://analytics_service/;
            proxy_set_header x-user-id  $http_x_user_id;
            proxy_set_header x-brand-id $http_x_brand_id;
            proxy_set_header x-role     $http_x_role;
        }
    }
}
